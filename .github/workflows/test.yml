name: Direct download âžœ upload to od

on:
  workflow_dispatch:
    inputs:
      file_url:
        description: 'ç›´é“¾ï¼ˆå¯å¤šè¡Œï¼Œæ¯è¡Œä¸€ä¸ª URLï¼‰'
        required: true
      dest_path:
        description: 'ä¸Šä¼ åˆ° od: çš„å­ç›®å½•ï¼Œä¾‹å¦‚ movie/2025/'
        required: true
        default: ''

jobs:
  download_and_upload:
    runs-on: macos-latest          # è‹¥æƒ³æ¢ Linuxï¼ŒæŠŠè¿™ä¸€è¡Œæ”¹æˆ ubuntu-latest

    env:
      # ä¸Šä¼ æ€§èƒ½å‚æ•°ï¼Œå¯æŒ‰éœ€è°ƒæ•´
      TRANSFERS: 32
      CHECKERS: 32
      BUFFER_SIZE: 1G
      THREAD_STREAMS: 8
      THREAD_CUTOFF: 16M
      DRIVE_CHUNK_SIZE: 256M
      STATS: 30s

    steps:
    # ---------- ï¼ˆå¯é€‰ï¼‰æ£€å‡ºä»“åº“ ----------
    - name: Checkout (optional)
      uses: actions/checkout@v4

    # ---------- å®‰è£… rclone ----------
    - name: Install rclone
      run: |
        curl -fsSL https://rclone.org/install.sh | sudo bash
        rclone version

    # ---------- è§£ç  rclone é…ç½® (Base64) ----------
    - name: Decode rclone.conf (base64)
      env:
        RCLONE_CONFIG_BASE64: ${{ secrets.RCLONE_CONFIG }}
      run: |
        mkdir -p ~/.config/rclone
        echo "$RCLONE_CONFIG_BASE64" | base64 -d > ~/.config/rclone/rclone.conf
        echo "âœ… rclone.conf decoded"

    # ---------- ä¸‹è½½ç›´é“¾ ----------
    - name: Download file(s)
      run: |
        mkdir -p downloads
        echo "${{ github.event.inputs.file_url }}" > /tmp/urls.txt
        aria2c --continue=true                 \
               --max-connection-per-server=16  \
               --split=16                      \
               --dir=downloads                 \
               --input-file=/tmp/urls.txt
        ls -lh downloads

    # ---------- ä¸Šä¼ åˆ° od ----------
    - name: Upload via rclone
      run: |
        DEST_DIR="od:${{ github.event.inputs.dest_path }}"
        echo "ðŸ“¤ Uploading to $DEST_DIR"
        rclone copy downloads "$DEST_DIR" \
          --transfers   "$TRANSFERS" \
          --checkers    "$CHECKERS" \
          --buffer-size "$BUFFER_SIZE" \
          --multi-thread-streams "$THREAD_STREAMS" \
          --multi-thread-cutoff  "$THREAD_CUTOFF" \
          --drive-chunk-size     "$DRIVE_CHUNK_SIZE" \
          --stats       "$STATS" \
          --progress
