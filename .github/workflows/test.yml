name: Direct download âœ upload to od

on:
  workflow_dispatch:
    inputs:
      file_url:
        description: 'ç›´é“¾åœ°å€ï¼ˆå¯å†™å¤šè¡Œï¼Œæ¯è¡Œä¸€ä¸ª URLï¼‰'
        required: true
      dest_path:
        description: 'ä¸Šä¼ åˆ° od: çš„å­ç›®å½•ï¼Œä¾‹å¦‚ movie/2025/ï¼›ç•™ç©º=æ ¹ç›®å½•'
        required: true
        default: ''

jobs:
  download_and_upload:
    runs-on: ubuntu-latest            # å¦‚æœæ›´å–œæ¬¢ macOSï¼ŒæŠŠè¿™è¡Œæ”¹æˆ macos-latest

    env:
      RCLONE_STATS: 1s               # æ¯ 1 s æ‰“å°ä¸€æ¬¡è¿›åº¦
      TRANSFERS:   32
      CHECKERS:    32
      BUFFER_SIZE: 1G
      THREAD_STREAMS: 8
      THREAD_CUTOFF: 16M
      DRIVE_CHUNK_SIZE: 256M         # OneDrive/Google Drive ç±»ç”¨å¾—åˆ°
      ONEDRIVE_CHUNK_SIZE: 60M

    steps:
    # ---------- æ£€å‡ºä»“åº“ï¼ˆå¦‚æœä½ ç”¨ä¸åˆ°ï¼Œå¯ä»¥åˆ ï¼‰ ----------
    - name: Checkout
      uses: actions/checkout@v4

    # ---------- å®‰è£…ç³»ç»Ÿä¾èµ– ----------
    - name: Install system deps (aria2)
      run: sudo apt-get update && sudo apt-get install -y aria2

    # ---------- ä¸‹è½½ç›´é“¾ ----------
    - name: Download file(s)
      run: |
        mkdir -p downloads
        echo "${{ github.event.inputs.file_url }}" > /tmp/urls.txt
        echo "â¬‡ï¸  Download list:"
        cat /tmp/urls.txt

        aria2c --continue=true \
               --max-connection-per-server=16 \
               --split=16 \
               --dir=downloads \
               --input-file=/tmp/urls.txt

        echo "ğŸ‰ Downloads done"
        ls -lh downloads

    # ---------- å®‰è£…å¹¶åŠ è½½ rcloneï¼ˆçº¯æ–‡æœ¬ configï¼‰ ----------
    - name: Setup rclone (plain text)
      uses: AnimMouse/setup-rclone@v1
      with:
        rclone_config: ${{ secrets.RCLONE_CONFIG }}   # ç›´æ¥ç²˜è´´ rclone.conf å†…å®¹
        disable_base64: true

    # ---------- ä¸Šä¼ åˆ° OneDrive (od:) ----------
    - name: Upload via rclone
      run: |
        SRC_DIR="downloads"
        DEST_DIR="od:${{ github.event.inputs.dest_path }}"
        echo "ğŸ“¤ Copying $SRC_DIR âœ $DEST_DIR"

        rclone copy "$SRC_DIR" "$DEST_DIR" \
          --transfers             "$TRANSFERS" \
          --checkers              "$CHECKERS" \
          --buffer-size           "$BUFFER_SIZE" \
          --multi-thread-streams  "$THREAD_STREAMS" \
          --multi-thread-cutoff   "$THREAD_CUTOFF" \
          --drive-chunk-size      "$DRIVE_CHUNK_SIZE" \
          --onedrive-chunk-size   "$ONEDRIVE_CHUNK_SIZE" \
          --fast-list \
          --progress \
          --stats=$RCLONE_STATS
