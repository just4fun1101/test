name: Music to Rclone (macOS)

on:
  workflow_dispatch:
    inputs:
      music_url:
        description: "Playlist or audio URL (only use if you have download rights)"
        required: true
        type: string
      remote_path:
        description: "Path inside pik: remote (e.g. 'music/album1' or '.' for root)"
        required: true
        type: string

jobs:
  music_to_rclone:
    runs-on: macos-latest
    env:
      TERM: xterm-256color
      RCLONE_STATS: 1s
      HOMEBREW_NO_COLOR: 1
      HOMEBREW_NO_AUTO_UPDATE: 1

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Install yt-dlp (via Homebrew)
        run: |
          brew install yt-dlp || true
          yt-dlp --version

      - name: Restore cookies.txt from secret
        run: |
          echo "${{ secrets.YTDLP_COOKIES_B64 }}" | base64 --decode > cookies.txt

      - name: Run yt-dlp (with cookies)
        env:
          TERM: xterm-256color
        run: |
          mkdir -p Downloads
          yt-dlp \
            -x --audio-format opus \
            --embed-metadata \
            --embed-thumbnail \
            --parse-metadata "playlist_index:%(track_number)s" \
            --cookies cookies.txt \
            -o "Downloads/%(playlist_title)s/%(playlist_index)02d - %(artist)s - %(title)s.%(ext)s" \
            "${{ github.event.inputs.music_url }}"

      - name: Setup rclone (plain-text config)
        uses: AnimMouse/setup-rclone@v1
        with:
          rclone_config: ${{ secrets.RCLONE_CONFIG }}
          disable_base64: true

      - name: Upload Downloads/ to pik
        run: |
          SRC_DIR="Downloads/"
          DEST_DIR="pik:${{ github.event.inputs.remote_path }}"
          rclone copy "$SRC_DIR" "$DEST_DIR" \
            --transfers=32 \
            --checkers=32 \
            --fast-list \
            --multi-thread-streams=8 \
            --multi-thread-cutoff=16M \
            --buffer-size=1G \
            --drive-chunk-size=256M \
            --onedrive-chunk-size=60M \
            --stats-one-line \
            --stats="${RCLONE_STATS}"
