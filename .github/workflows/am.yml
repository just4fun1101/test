name: apple‑music‑to‑onedrive

on:
  workflow_dispatch:
    inputs:
      apple_urls:
        description: 'Apple Music 链接（多条用空格/换行分隔）'
        required: true
      dst_path:
        description: 'OneDrive 目标目录（相对于 od: Remote）'
        required: true
        default: 'music/'

jobs:
  am2od:
    runs-on: macos-latest

    env:
      COOKIES_FILE: ${{ github.workspace }}/cookies.txt
      ONEDRIVE_REMOTE: od

    steps:
    # ---------- rclone ----------
    - uses: AnimMouse/setup-rclone@v1
      with:
        rclone_config: ${{ secrets.RCLONE_CONFIG }}
        disable_base64: true

    # ---------- gamdl + ffmpeg ----------
    - name: Install gamdl & ffmpeg (pip)
      run: |
        pipx install --force gamdl        # 自带隔离，自动拉最新
        brew install ffmpeg
        gamdl --version                   # 确认 ≥ 2.5.2

    # ---------- cookies ----------
    - name: Write cookies.txt
      run: |
        echo "${{ secrets.APPLE_COOKIES }}" > "$COOKIES_FILE"

    # ---------- auth sanity check ----------
    - name: Check Apple Music auth
      run: |
        gamdl --check-auth -c "$COOKIES_FILE"

    # ---------- download ----------
    - name: Download with gamdl
      shell: bash
      env:
        URLS: ${{ github.event.inputs.apple_urls }}
      run: |
        set -Eeuxo pipefail
        mkdir -p downloads
        declare -a failed=()
        IFS=$'\n' read -rd '' -a arr <<< "$URLS"
        for url in "${arr[@]}"; do
          echo "🎵  $url"
          if ! gamdl -c "$COOKIES_FILE" -o downloads --overwrite "$url"; then
            echo "⚠️  FAILED: $url"
            failed+=("$url")
          fi
        done
        echo "✅  Downloads done. Size:"
        du -sh downloads || true
        if ((${#failed[@]})); then
          printf '%s\n' "${failed[@]}" > failed.txt
          echo "::warning title=Some downloads failed::See failed.txt in artifacts"
        fi

    # ---------- upload ----------
    - name: Move to OneDrive
      run: |
        rclone move "downloads/" "${ONEDRIVE_REMOTE}:${{ github.event.inputs.dst_path }}" \
          --transfers=64 --checkers=64 --fast-list \
          --buffer-size=1G --multi-thread-streams=16 --multi-thread-cutoff=64M \
          --drive-chunk-size=128M --onedrive-chunk-size=160M \
          --stats=1s --retries=3 --retries-sleep=10s
