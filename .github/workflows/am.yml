name: apple‑music‑to‑onedrive

on:
  workflow_dispatch:
    inputs:
      apple_urls:
        description: 'Apple Music 链接（多条可用空格/换行分隔）'
        required: true
      dst_path:
        description: 'OneDrive 目标目录（相对于 od: Remote）'
        required: true
        default: 'music/'

jobs:
  am2od:
    runs-on: macos-latest

    env:
      COOKIES_FILE: ${{ github.workspace }}/cookies.txt
      ONEDRIVE_REMOTE: od           # ← 与 rclone.conf 中的 Remote 名称保持一致

    steps:
    # 1) rclone（纯文本 conf）
    - uses: AnimMouse/setup-rclone@v1
      with:
        rclone_config: ${{ secrets.RCLONE_CONFIG }}
        disable_base64: true

    # 2) 释放磁盘空间
    - name: Free disk space
      run: |
        sudo rm -rf /usr/local/share/dotnet \
                     "$(brew --prefix)/share/android-commandlinetools" \
                     /usr/local/lib/android /opt/ghc /usr/local/lib/codeql \
                     /Applications/Xcode*.app || true
        df -h /

    # 3) 安装 gamdl + FFmpeg
    - name: Install gamdl & ffmpeg
      run: |
        pipx install --force gamdl          # 始终拉取最新版
        brew install ffmpeg
        gamdl --version

    # 4) 写入 cookies.txt
    - name: Write cookies.txt
      run: |
        echo "${{ secrets.APPLE_COOKIES }}" > "$COOKIES_FILE"

    # 5) 下载 Apple Music
    - name: Download with gamdl
      shell: bash
      env:
        URLS: ${{ github.event.inputs.apple_urls }}
      run: |
        set -Eeuo pipefail
        mkdir -p downloads
        IFS=$'\n' read -rd '' -a arr <<< "$URLS"
        failed=()
        for url in "${arr[@]}"; do
          echo "🎵  $url"
          if gamdl -c "$COOKIES_FILE" -o downloads --overwrite "$url"; then
            echo "✅  OK"
          else
            echo "⚠️  FAILED: $url"
            failed+=("$url")
          fi
        done
        du -sh downloads || true
        if ((${#failed[@]})); then
          printf '%s\n' "${failed[@]}" > failed.txt
          echo "::warning title=Some downloads failed::See failed.txt in artifacts"
        fi

    # 6) 上传到 OneDrive（完成后删除本地文件）
    - name: Move to OneDrive
      run: |
        rclone move "downloads/" "${ONEDRIVE_REMOTE}:${{ github.event.inputs.dst_path }}" \
          --transfers=64 --checkers=64 --fast-list \
          --buffer-size=1G --multi-thread-streams=16 --multi-thread-cutoff=64M \
          --drive-chunk-size=128M --onedrive-chunk-size=160M \
          --stats=1s --retries=3 --retries-sleep=10s
