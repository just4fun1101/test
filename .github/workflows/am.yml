name: appleâ€‘musicâ€‘toâ€‘onedrive

on:
  workflow_dispatch:
    inputs:
      apple_urls:
        description: 'Apple Music é“¾æŽ¥ï¼ˆå¤šæ¡å¯ç”¨ç©ºæ ¼/æ¢è¡Œåˆ†éš”ï¼‰'
        required: true
      dst_path:
        description: 'OneDrive ç›®æ ‡ç›®å½•ï¼ˆç›¸å¯¹äºŽ od: Remoteï¼‰'
        required: true
        default: 'music/'

jobs:
  am2od:
    runs-on: macos-latest

    env:
      COOKIES_FILE: ${{ github.workspace }}/cookies.txt
      ONEDRIVE_REMOTE: od

    steps:
    # ---------- rclone ----------
    - uses: AnimMouse/setup-rclone@v1
      with:
        rclone_config: ${{ secrets.RCLONE_CONFIG }}
        disable_base64: true

    # ---------- free up space ----------
    - name: Free disk space
      run: |
        sudo rm -rf /usr/local/share/dotnet \
                     "$(brew --prefix)/share/android-commandlinetools" \
                     /usr/local/lib/android /opt/ghc /usr/local/lib/codeql \
                     /Applications/Xcode*.app || true
        df -h /

    # ---------- gamdl + ffmpeg ----------
    - name: Install gamdl & ffmpeg
      run: |
        pipx install --force gamdl        # æ‹‰å–æœ€æ–°ç‰ˆ
        brew install ffmpeg
        gamdl --version

    # ---------- cookies ----------
    - name: Write cookies.txt
      run: |
        echo "${{ secrets.APPLE_COOKIES }}" > "$COOKIES_FILE"

    # ---------- download ----------
    - name: Download with gamdl
      shell: bash
      env:
        URLS: ${{ github.event.inputs.apple_urls }}
      run: |
        set -Eeuo pipefail
        mkdir -p downloads
        IFS=$'\n' read -rd '' -a arr <<< "$URLS"
        failed=()
        for url in "${arr[@]}"; do
          echo "ðŸŽµ  $url"
          if ! gamdl -c "$COOKIES_FILE" -o downloads --overwrite "$url"; then
            echo "âš ï¸  FAILED: $url"
            failed+=("$url")
          fi
        done
        du -sh downloads || true
        if ((${#failed[@]})); then
          printf '%s\n' "${failed[@]}" > failed.txt
          echo "::warning title=Some downloads failed::See failed.txt in artifacts"
        fi

    # ---------- upload ----------
    - name: Move to OneDrive
      run: |
        rclone move "downloads/" "${ONEDRIVE_REMOTE}:${{ github.event.inputs.dst_path }}" \
          --transfers=64 --checkers=64 --fast-list \
          --buffer-size=1G --multi-thread-streams=16 --multi-thread-cutoff=64M \
          --drive-chunk-size=128M --onedrive-chunk-size=160M \
          --stats=1s --retries=3 --retries-sleep=10s
