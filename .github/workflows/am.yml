name: appleâ€‘music-to-onedrive (macOS)

on:
  workflow_dispatch:
    inputs:
      apple_urls:
        description: 'AppleÂ Music é“¾æŽ¥ï¼ˆå¯å¡«å¤šæ¡ï¼Œç”¨ç©ºæ ¼æˆ–æ¢è¡Œåˆ†éš”ï¼‰'
        required: true
        default: ''
      dst_path:
        description: 'ä¸Šä¼ åˆ° OneDrive çš„ç›®å½•ï¼ˆç›¸å¯¹äºŽ od: Remoteï¼Œä¾‹å¦‚ music/ ï¼‰'
        required: true
        default: 'music/'

jobs:
  download-and-upload:
    runs-on: macos-latest   # macOSÂ 14 (Sonoma) Runner

    env:
      # æœ¬åœ°ä¿å­˜ cookies çš„è·¯å¾„
      COOKIES_FILE: ${{ github.workspace }}/cookies.txt
      # rclone Remote åç§°ï¼ˆä¸Ž rclone.conf ä¸­ä¿æŒä¸€è‡´ï¼‰
      ONEDRIVE_REMOTE: od

    steps:
    # 1) æ£€å‡ºä»“åº“ï¼ˆå¦‚éœ€ç”¨åˆ°ä»£ç ï¼Œå¯ä¿ç•™ï¼›çº¯è·‘ä»»åŠ¡ä¹Ÿå¯åˆ é™¤ï¼‰
    - name: Checkout repo
      uses: actions/checkout@v4

    # 2) å†™å…¥ rclone é…ç½®ï¼ˆçº¯æ–‡æœ¬ï¼‰
    - name: Setup rclone (plain text conf)
      uses: AnimMouse/setup-rclone@v1
      with:
        rclone_config: ${{ secrets.RCLONE_CONFIG }}   # çº¯æ–‡æœ¬ rclone.conf
        disable_base64: true

    # 4) å®‰è£… gamdl + FFmpeg
    - name: Install gamdl & FFmpeg
      run: |
        brew update
        brew install gamdl ffmpeg
        gamdl --version
        ffmpeg -version | head -n 1

    # 5) å†™å…¥ cookies.txt
    - name: Write Apple Music cookies
      shell: bash
      run: |
        printf '%s' "${{ secrets.APPLE_COOKIES }}" > "$COOKIES_FILE"
        echo "Cookies saved to $COOKIES_FILE"

    # 6) ä½¿ç”¨ gamdl ä¸‹è½½ AppleÂ Music
    - name: Download from Apple Music
      shell: bash
      env:
        URLS: ${{ github.event.inputs.apple_urls }}
      run: |
        mkdir -p "$GITHUB_WORKSPACE/downloads"
        IFS=$'\n' read -rd '' -a url_array <<< "$URLS"
        for url in "${url_array[@]}"; do
          echo "ðŸŽµ Downloading $url ..."
          gamdl \
            --cookies-path "$COOKIES_FILE" \
            --output-path "$GITHUB_WORKSPACE/downloads" \
            --overwrite \
            "$url"
        done
        echo "âœ… All downloads finished."
        du -sh "$GITHUB_WORKSPACE/downloads"

    # 7) ä¸Šä¼ åˆ° OneDrive
    - name: Upload to OneDrive
      shell: bash
      run: |
        SRC="$GITHUB_WORKSPACE/downloads/"
        DST="${ONEDRIVE_REMOTE}:${{ github.event.inputs.dst_path }}"
        echo "ðŸ“ æºç›®å½• = $SRC"
        echo "ðŸ“ ç›®æ ‡ç›®å½• = $DST"

        rclone copy "$SRC" "$DST" \
          --transfers=64 \
          --checkers=64 \
          --fast-list \
          --max-backlog=999999 \
          --buffer-size=1G \
          --multi-thread-streams=16 \
          --multi-thread-cutoff=64M \
          --drive-chunk-size=128M \
          --onedrive-chunk-size=160M \
          --retries=3 \
          --retries-sleep=10s \
          --progress \
          --stats=1s
