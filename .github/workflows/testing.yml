name: pikpak-linuxæµ‹è¯•

on:
  workflow_dispatch:
    inputs:
      src_path:
        description: 'æºç›®å½•ï¼Œç›¸å¯¹äº new: Remoteï¼Œæ¯”å¦‚ï¼šmyFolder/ ï¼ˆæ³¨æ„å¸¦æ–œæ ï¼‰'
        required: true
        default: ''
      dst_path:
        description: 'ç›®æ ‡ç›®å½•ï¼Œç›¸å¯¹äº od: Remoteï¼Œæ¯”å¦‚ï¼šbackup/ ï¼ˆæ³¨æ„å¸¦æ–œæ ï¼‰'
        required: true
        default: ''

jobs:
  transfer:
    runs-on: ubuntu-latest
    steps:
      # 1. æ£€å‡ºä»£ç 
      - name: Checkout ä»£ç 
        uses: actions/checkout@v3

      # 2. è®¾ç½® Python ç¯å¢ƒ
      - name: è®¾ç½® Python 3.x
        uses: actions/setup-python@v4
        with:
          python-version: '3.x'

      # 3. å®‰è£… WebDAV å®¢æˆ·ç«¯
      - name: å®‰è£… webdavclient3
        run: pip install webdavclient3

      # 4. ä» WebDAV ä¸‹è½½åˆ°æœ¬åœ° ./src
      - name: ä» WebDAV ä¸‹è½½åˆ°æœ¬åœ°
        # workflow_dispatch inputs ä¼šè‡ªåŠ¨å†™å…¥ç¯å¢ƒå˜é‡ INPUT_SRC_PATH
        run: python download_webdav.py "${{ github.event.inputs.src_path }}"
        env:
          WEBDAV_HOSTNAME: ${{ secrets.WEBDAV_HOSTNAME }}
          WEBDAV_USERNAME:  ${{ secrets.WEBDAV_USERNAME }}
          WEBDAV_PASSWORD:  ${{ secrets.WEBDAV_PASSWORD }}

      # 5. å®‰è£…å¹¶åŠ è½½ rcloneï¼ˆçº¯æ–‡æœ¬ configï¼‰
      - name: å®‰è£…å¹¶åŠ è½½ Rclone
        uses: AnimMouse/setup-rclone@v1
        with:
          rclone_config: ${{ secrets.RCLONE_CONFIG }}
          disable_base64: true

      # 6. ç”¨ rclone æŠŠæœ¬åœ° ./src ä¸Šä¼ åˆ° od:${{ dst_path }}
      - name: é«˜é€Ÿæ‹·è´ æœ¬åœ° ./src åˆ° od:${{ github.event.inputs.dst_path }}
        run: |
          SRC="./src/"
          DST="od:${{ github.event.inputs.dst_path }}"
          echo "ğŸ“ æœ¬åœ°æºç›®å½• = $SRC"
          echo "ğŸ“ ç›®æ ‡ç›®å½• = $DST"
          rclone copy "$SRC" "$DST" \
            --ignore-existing \
            --transfers=24 \
            --checkers=32 \
            --fast-list \
            --buffer-size=1G \
            --multi-thread-streams=16 \
            --multi-thread-cutoff=64M \
            --drive-chunk-size=128M \
            --onedrive-chunk-size=160M \
            --timeout=20s \
            --low-level-retries=5 \
            --retries=10 \
            --retries-sleep=50s \
            --ignore-errors \
            --progress \
            --stats=10s
