name: pikpak-linux

on:
  workflow_dispatch:
    inputs:
      src_path:
        description: 'WebDAV é‡Œçš„æºç›®å½•ï¼Œä¾‹å¦‚ï¼š/myFolder/ï¼ˆæ³¨æ„å¸¦æ–œæ ï¼‰'
        required: true
        default: ''
      dst_path:
        description: 'ç›®æ ‡ç›®å½•ï¼Œç›¸å¯¹äº od: Remoteï¼Œä¾‹å¦‚ï¼šbackup/ï¼ˆæ³¨æ„å¸¦æ–œæ ï¼‰'
        required: true
        default: ''

jobs:
  transfer:
    runs-on: ubuntu-latest

    steps:
      # 1. å–ä»£ç ï¼ˆå¯é€‰ï¼Œç”¨æ¥æ”¾è„šæœ¬ï¼‰
      - name: Checkout ä»£ç 
        uses: actions/checkout@v3

      # 2. ğŸ†•  å®‰è£… Python & WebDAV å®¢æˆ·ç«¯
      - name: è®¾ç½® Python å¹¶å®‰è£… webdav-client
        uses: actions/setup-python@v5
        with:
          python-version: '3.12'
      - name: pip install webdav-client
        run: pip install webdavclient3

      # 3. ğŸ†•  ä» WebDAV ä¸‹è½½åˆ°å·¥ä½œç©ºé—´
      - name: ä¸‹è½½ WebDAV æºæ–‡ä»¶
        env:
          WEBDAV_HOSTNAME: ${{ secrets.WEBDAV_HOSTNAME }}   # ä¾‹å¦‚ https://dav.example.com
          WEBDAV_USERNAME: ${{ secrets.WEBDAV_USERNAME }}
          WEBDAV_PASSWORD: ${{ secrets.WEBDAV_PASSWORD }}
          SRC_PATH:        ${{ github.event.inputs.src_path }}
        run: |
          python <<'PY'
          import os, pathlib, sys
          from webdav3.client import Client

          opts = {
              'webdav_hostname': os.getenv('WEBDAV_HOSTNAME'),
              'webdav_login':    os.getenv('WEBDAV_USERNAME'),
              'webdav_password': os.getenv('WEBDAV_PASSWORD'),
          }
          client = Client(opts)

          remote = os.getenv('SRC_PATH')
          # ç»Ÿä¸€ä»¥ / ç»“å°¾ï¼Œä¾¿äºé€’å½’
          if not remote.endswith('/'):
              remote += '/'
          local = 'webdav_download'
          pathlib.Path(local).mkdir(exist_ok=True)
          print(f"â¬‡ï¸  download {remote}  ->  {local}/")
          client.download_sync(remote_path=remote, local_path=local)
          PY
          echo "âœ… WebDAV ä¸‹è½½å®Œæˆ"

      # 4. å®‰è£… rcloneï¼ˆä»ç”¨çº¯æ–‡æœ¬ configï¼‰
      - name: å®‰è£…å¹¶åŠ è½½ Rclone
        uses: AnimMouse/setup-rclone@v1
        with:
          rclone_config: ${{ secrets.RCLONE_CONFIG }}
          disable_base64: true

      # 5. æŠŠæœ¬åœ° webdav_download/* ä¼ åˆ° OneDrive è¿œç«¯
      - name: é«˜é€Ÿæ‹·è´åˆ° od:${{ github.event.inputs.dst_path }}
        run: |
          SRC="webdav_download/"
          DST="od:${{ github.event.inputs.dst_path }}"
          echo "ğŸ“ æºç›®å½• = $SRC"
          echo "ğŸ“ ç›®æ ‡ç›®å½• = $DST"
          rclone copy "$SRC" "$DST" \
            --ignore-existing \
            --transfers=24 \
            --checkers=32 \
            --fast-list \
            --buffer-size=1G \
            --multi-thread-streams=16 \
            --multi-thread-cutoff=64M \
            --drive-chunk-size=128M \
            --onedrive-chunk-size=160M \
            --timeout=20s \
            --low-level-retries=5 \
            --retries=10 \
            --retries-sleep=50s \
            --ignore-errors \
            --progress \
            --stats=10s
