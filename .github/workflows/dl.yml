name: DoodDL

on:
  workflow_dispatch:
    inputs:
      dood_urls:
        description: "Doodstream /d/ 页面 URL，多个空格分开"
        required: true
      dst_dir:
        description: "上传到 OneDrive 目标子目录"
        required: true

env:
  DL_DIR: downloads

jobs:
  run:
    runs-on: ubuntu-latest
    steps:
    # 检出
    - uses: actions/checkout@v4

    # Python & yt‑dlp
    - name: Install deps
      run: |
        sudo apt-get update -qq
        sudo apt-get install -y python3-pip
        pip install -U yt-dlp beautifulsoup4 requests tqdm
        # 把 dood.py 放仓根；若在子目录请修改路径
        chmod +x dood.py

    # rclone（纯文本 config）
    - name: Set up rclone
      uses: AnimMouse/setup-rclone@v1
      with:
        rclone_config: ${{ secrets.RCLONE_CONFIG }}
        disable_base64: true

    # 下载
    - name: Download from Doodstream
      run: |
        python dood.py ${{ github.event.inputs.dood_urls }} -o "${{ env.DL_DIR }}"
        echo "Downloaded files:" && ls -R "${{ env.DL_DIR }}"

    # 上传
    - name: Upload to OneDrive
      run: |
        rclone copy "${{ env.DL_DIR }}" "od:${{ github.event.inputs.dst_dir }}" \
          --transfers=8 --checkers=16 --fast-list --stats=30s -P

    # 失败时收集日志
    - uses: actions/upload-artifact@v4
      if: failure()
      with:
        name: debug
        path: ${{ env.DL_DIR }}
        retention-days: 3
