name: testdl

on:
  workflow_dispatch:
    inputs:
      ph_urls:
        description: "PornHoarder 视频页 URL，多个用空格分开"
        required: true
      dst_dir:
        description: "OneDrive 目标子目录，如 PH/"
        required: true
      max_quality:
        description: "最高分辨率（p）"
        required: false
        default: "1080"

env:
  PYTHON_VERSION: "3.12"
  DL_DIR: "downloads"

jobs:
  dl_and_upload:
    runs-on: ubuntu-latest

    steps:
    
      # 1) 检出仓库
      - name: Checkout repo
        uses: actions/checkout@v4

      # 2) 安装 Python
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}

      # 3) 安装所需 Python 包
      - name: Install Python deps
        run: |
          python -m pip install --upgrade pip
          pip install yt-dlp cloudscraper beautifulsoup4 tqdm

      # 4) 安装并加载 rclone（纯文本 config）
      - name: Set up rclone
        uses: AnimMouse/setup-rclone@v1
        with:
          rclone_config: ${{ secrets.RCLONE_CONFIG }}
          disable_base64: true         # 你的 config 不是 base64 就设为 true

      # 5) 解析并下载 PornHoarder 视频
      - name: Download from PornHoarder
        run: |
          python dl.py ${{ github.event.inputs.ph_urls }} \
                 -o "${{ env.DL_DIR }}" \
                 --quality "${{ github.event.inputs.max_quality }}"
          echo "✅ 下载完毕"; ls -R "${{ env.DL_DIR }}"

      # 6) 上传到 OneDrive（假设远程名为 od:）
      - name: Rclone upload
        run: |
          rclone copy "${{ env.DL_DIR }}" "od:${{ github.event.inputs.dst_dir }}" \
            --transfers=8 --checkers=16 --fast-list --stats=30s -P

      # 7) 失败时保存调试文件
      - name: Upload artifacts on failure
        if: ${{ failure() }}
        uses: actions/upload-artifact@v4
        with:
          name: debug-logs
          path: |
            ${{ env.DL_DIR }}
            ~/.config/rclone/rclone.log
          retention-days: 3
