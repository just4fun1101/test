name: sxyprn-od

on:
  workflow_dispatch:
    inputs:
      sxyprn_url:
        description: '要下载的 SxyPrn 视频或专辑链接'
        required: true
      dest_dir:
        description: '上传至 OneDrive 的目标子目录（默认为 lil vids）'
        required: false
        default: 'lil vids'

jobs:
  download_and_upload:
    runs-on: ubuntu-latest

    steps:
      # 1. （可选）签出仓库代码
      - name: Checkout repository
        uses: actions/checkout@v3

      # 2. 安装 Python 3
      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.x'

      # 3. 安装 yt-dlp
      - name: Install yt-dlp
        run: |
          python -m pip install --upgrade pip
          pip install yt-dlp

      # 4. 安装 uncensored 插件
      - name: Install yt-dlp-uncensored-plugin
        run: |
          mkdir -p ~/.config/yt-dlp/plugins
          git clone \
            https://github.com/mirkul-yeah/yt-dlp-uncensored-plugin.git \
            ~/.config/yt-dlp/plugins/yt-dlp-uncensored-plugin

      # 5. 使用 yt-dlp 原生分片并发下载
      - name: Download from SxyPrn (原生分片并发)
        run: |
          DOWNLOAD_DIR=downloads
          mkdir -p "$DOWNLOAD_DIR"
          yt-dlp \
            --restrict-filenames \
            --concurrent-fragments 8 \
            --fragment-retries 5 \
            -o "${DOWNLOAD_DIR}/%(id)s.%(ext)s" \
            "${{ github.event.inputs.sxyprn_url }}"

      # 6. 安装并配置 Rclone
      - name: Install and configure Rclone
        uses: AnimMouse/setup-rclone@v1
        with:
          rclone_config: ${{ secrets.RCLONE_CONFIG }}
          disable_base64: true

      # 7. 上传下载结果到 OneDrive
      - name: Upload to OneDrive
        run: |
          SRC="./downloads"
          DST="od:${{ github.event.inputs.dest_dir }}"
          echo "📁 源目录 = $SRC"
          echo "📁 目标目录 = $DST"
          rclone copy \
            "$SRC" \
            "$DST" \
            --transfers=16 \
            --checkers=16 \
            --fast-list \
            --progress
