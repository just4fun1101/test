name: gamdl

on:
  workflow_dispatch:                # â¬… æ‰‹å‹•è§¸ç™¼ï¼‹è¡¨å–®
    inputs:
      urls:
        description: "AppleÂ Music é€£çµï¼ˆç©ºæ ¼åˆ†éš”ï¼‰"
        required:  true
      dest_dir:
        description: "ä¸Šå‚³åˆ° od: çš„å­ç›®éŒ„ï¼Œä¾‹å¦‚ music/"
        required:  true

jobs:
  gamdl_to_onedrive:
    runs-on: macos-latest           # ğŸ’¡å¯æ”¹ ubuntu-22.04ï¼Œä½†éœ€è‡ªè¡Œè£ ffmpeg

    steps:

      # 1ï¸âƒ£ å–ç”¨ç¨‹å¼ç¢¼ï¼ˆå¯æ”¾ç©º repoï¼Œä¹Ÿå¯ä»¥æ˜¯ä½ çš„è…³æœ¬/è¨­å®šï¼‰
      - uses: actions/checkout@v4

      # 2ï¸âƒ£ å®‰è£ Python + gamdl
- uses: actions/setup-python@v5
  with:
    python-version: "3.12"
- run: python -m pip install -U pip gamdl

# 2ï¸âƒ£â€‘b ç¢ºä¿ FFmpeg å­˜åœ¨
- name: Ensure FFmpeg
  run: |
    if ! command -v ffmpeg; then
      brew install ffmpeg
    fi


      # 3ï¸âƒ£ é‚„åŸ cookies.txtï¼ˆå¾ Secrets ä¾†ï¼‰
      - name: Restore cookies.txt
        env:
          AM_COOKIES_B64: ${{ secrets.AM_COOKIES_B64 }}
        run: |
          echo "$AM_COOKIES_B64" | base64 --decode > cookies.txt

      # 4ï¸âƒ£ ä¸‹è¼‰ï¼ˆæŠŠä½¿ç”¨è€…è¡¨å–®è£¡çš„ URL é€æ¢ä¸Ÿçµ¦ gamdlï¼‰
      - name: Download with gamdl
        run: |
          mkdir downloads
          read -ra ARR <<< "${{ github.event.inputs.urls }}"
          for u in "${ARR[@]}"; do
            gamdl -f downloads "$u"
          done

      # 5ï¸âƒ£ å®‰è£ rcloneï¼Œå¯«å…¥ç´”æ–‡å­— rclone.conf
      - uses: AnimMouse/setup-rclone@v1
        with:
          rclone_config: ${{ secrets.RCLONE_CONFIG }}   # ğŸ’¡ç´”æ–‡å­—å°±è¨­ disable_base64: true
          disable_base64: true

      # 6ï¸âƒ£ ä¸Šå‚³åˆ° OneDrive
      - name: Upload to OneDrive
        run: |
          rclone copy downloads "od:${{ github.event.inputs.dest_dir }}" \
                 --transfers 32 --checkers 32 --fast-list \
                 --progress --stats 30s
