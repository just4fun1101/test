name: Bunkr to Rclone (macOS)

on:
  workflow_dispatch:
    inputs:
      bunkr_url:
        description: "Bunkr album or file URL"
        required: true
        type: string

jobs:
  bunkr_to_rclone:
    runs-on: macos-latest
    env:
      TERM: xterm-256color
      RCLONE_STATS: 1s
      HOMEBREW_NO_COLOR: 1
      HOMEBREW_NO_AUTO_UPDATE: 1

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Install dependencies (macOS)
        run: |
          brew install python git || true
          python3 --version
          git --version

      - name: Download and run BunkrDownloader (non-interactive)
        env:
          TERM: xterm-256color
        run: |
          git clone https://github.com/Lysagxra/BunkrDownloader.git
          cd BunkrDownloader
          python3 -m venv venv
          source venv/bin/activate
          python3 -m pip install --upgrade pip
          python3 -m pip install -r requirements.txt
          python3 downloader.py "${{ github.event.inputs.bunkr_url }}" --disable-ui

      - name: Setup rclone (plain-text config)
        uses: AnimMouse/setup-rclone@v1
        with:
          rclone_config: ${{ secrets.RCLONE_CONFIG }}
          disable_base64: true

      - name: Upload Downloads/ to od:lil vids
        run: |
          SRC_DIR="BunkrDownloader/Downloads/"
          DEST_DIR="od:lil vids"
          rclone copy "$SRC_DIR" "$DEST_DIR" \
            --transfers=32 \
            --checkers=32 \
            --fast-list \
            --multi-thread-streams=8 \
            --multi-thread-cutoff=16M \
            --buffer-size=1G \
            --drive-chunk-size=256M \
            --onedrive-chunk-size=60M \
            --stats-one-line \
            --stats="${RCLONE_STATS}"
